import React, { useState, useEffect } from 'react';
import NodeCard from '../components/NodeCard';
import AddNodeModal from '../components/AddNodeModal';

function Nodes() {
  const [nodes, setNodes] = useState([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('all'); // all, online, offline
  const [showAddModal, setShowAddModal] = useState(false);

  useEffect(() => {
    fetchNodes();
    const interval = setInterval(fetchNodes, 10000);
    return () => clearInterval(interval);
  }, []);

  const fetchNodes = async () => {
    try {
      const res = await fetch('/api/nodes');
      const json = await res.json();
      
      // æ·»åŠ  bot_count
      for (const node of json) {
        const botsRes = await fetch(`/api/nodes/${node.id}/bots`);
        const bots = await botsRes.json();
        node.bot_count = bots.length;
      }
      
      setNodes(json);
      setLoading(false);
    } catch (error) {
      console.error('Failed to fetch nodes:', error);
      setLoading(false);
    }
  };

  const filteredNodes = nodes.filter(node => {
    if (filter === 'all') return true;
    if (filter === 'online') return node.status === 'online';
    if (filter === 'offline') return node.status !== 'online';
    return true;
  });

  const onlineCount = nodes.filter(n => n.status === 'online').length;
  const offlineCount = nodes.length - onlineCount;

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="text-gray-400 text-lg">åŠ è½½ä¸­...</div>
      </div>
    );
  }

  return (
    <div className="space-y-6 pb-20 md:pb-0">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold text-white">ğŸ–¥ï¸ èŠ‚ç‚¹ç®¡ç†</h1>
        <button 
          onClick={() => setShowAddModal(true)}
          className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors"
        >
          + æ·»åŠ èŠ‚ç‚¹
        </button>
      </div>

      {/* çŠ¶æ€è¿‡æ»¤ */}
      <div className="flex items-center space-x-4 bg-gray-800 rounded-lg border border-gray-700 p-4">
        <button
          onClick={() => setFilter('all')}
          className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
            filter === 'all'
              ? 'bg-blue-600 text-white'
              : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
          }`}
        >
          å…¨éƒ¨ ({nodes.length})
        </button>
        <button
          onClick={() => setFilter('online')}
          className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
            filter === 'online'
              ? 'bg-green-600 text-white'
              : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
          }`}
        >
          ğŸŸ¢ åœ¨çº¿ ({onlineCount})
        </button>
        <button
          onClick={() => setFilter('offline')}
          className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
            filter === 'offline'
              ? 'bg-red-600 text-white'
              : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
          }`}
        >
          ğŸ”´ ç¦»çº¿ ({offlineCount})
        </button>
      </div>

      {/* èŠ‚ç‚¹ç½‘æ ¼ */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        {filteredNodes.map(node => (
          <NodeCard key={node.id} node={node} />
        ))}
      </div>

      {filteredNodes.length === 0 && (
        <div className="text-center text-gray-500 py-12 bg-gray-800 rounded-lg border border-gray-700">
          {filter === 'all' ? 'æš‚æ— èŠ‚ç‚¹' : `æš‚æ— ${filter === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿'}èŠ‚ç‚¹`}
        </div>
      )}

      <AddNodeModal
        isOpen={showAddModal}
        onClose={() => setShowAddModal(false)}
        onSuccess={fetchNodes}
      />
    </div>
  );
}

export default Nodes;
