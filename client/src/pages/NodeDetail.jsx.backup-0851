import React, { useState, useEffect } from 'react';
import { useParams, Link, useNavigate } from 'react-router-dom';
import { maskKey, getProviderName, getProviderColor, getStatusIcon, getPlatformIcon } from '../utils/maskKey';
import ImplementationModal from '../components/ImplementationModal';
import AddBotModal from '../components/AddBotModal';
import ConfirmDialog from '../components/ConfirmDialog';

function NodeDetail() {
  const { id } = useParams();
  const navigate = useNavigate();
  const [data, setData] = useState(null);
  const [keys, setKeys] = useState([]);
  const [bots, setBots] = useState([]);
  const [skills, setSkills] = useState([]);
  const [gatewayConfig, setGatewayConfig] = useState(null);
  const [loading, setLoading] = useState(true);
  const [tab, setTab] = useState('overview');
  const [showAddBotModal, setShowAddBotModal] = useState(false);
  const [modalData, setModalData] = useState(null);
  const [modalOpen, setModalOpen] = useState(false);
  const [confirmDialog, setConfirmDialog] = useState({ isOpen: false, action: null, data: null });
  const [actionLoading, setActionLoading] = useState(false);
  
  // Phase 7: Bot details (memory, sessions, cron)
  const [selectedBotId, setSelectedBotId] = useState(null);
  const [botMemoryHealth, setBotMemoryHealth] = useState([]);
  const [botSessions, setBotSessions] = useState([]);
  const [botCronJobs, setBotCronJobs] = useState([]);
  
  // åˆ†é¡µçŠ¶æ€
  const [backupsPage, setBackupsPage] = useState(1);
  const [scoresPage, setScoresPage] = useState(1);
  const [eventsPage, setEventsPage] = useState(1);
  // å¤„ç†è¿˜åŸæŒ‰é’®ç‚¹å‡» - è·³è½¬åˆ°å¤‡ä»½é¡µé¢
  const handleRestoreNavigation = () => {
    navigate(`/backups?node=${id}`);
  };

  const pageSize = 20;

  useEffect(() => {
    fetchNodeDetail();
    fetchKeys();
    fetchBots();
    fetchSkills();
    fetchGatewayConfig();
  }, [id]);
  
  useEffect(() => {
    if (selectedBotId) {
      fetchBotMemoryHealth(selectedBotId);
      fetchBotSessions(selectedBotId);
      fetchBotCronJobs(selectedBotId);
    }
  }, [selectedBotId]);

  const fetchNodeDetail = async () => {
    try {
      const res = await fetch(`/api/nodes/${id}`);
      const json = await res.json();
      setData(json);
      setLoading(false);
    } catch (error) {
      console.error('Failed to fetch node detail:', error);
      setLoading(false);
    }
  };

  const fetchKeys = async () => {
    try {
      const res = await fetch(`/api/nodes/${id}/keys`);
      const json = await res.json();
      setKeys(json);
    } catch (error) {
      console.error('Failed to fetch keys:', error);
    }
  };

  const fetchBots = async () => {
    try {
      const res = await fetch(`/api/nodes/${id}/bots`);
      const json = await res.json();
      setBots(json);
      // Auto-select first bot if exists
      if (json.length > 0 && !selectedBotId) {
        setSelectedBotId(json[0].id);
      }
    } catch (error) {
      console.error('Failed to fetch bots:', error);
    }
  };
  
  const fetchSkills = async () => {
    try {
      const res = await fetch(`/api/nodes/${id}/skills`);
      const json = await res.json();
      setSkills(json);
    } catch (error) {
      console.error('Failed to fetch skills:', error);
    }
  };
  
  const fetchGatewayConfig = async () => {
    try {
      const res = await fetch(`/api/nodes/${id}/config`);
      const json = await res.json();
      setGatewayConfig(json);
    } catch (error) {
      console.error('Failed to fetch gateway config:', error);
    }
  };
  
  const fetchBotMemoryHealth = async (botId) => {
    try {
      const res = await fetch(`/api/bots/${botId}/memory-health`);
      const json = await res.json();
      setBotMemoryHealth(json);
    } catch (error) {
      console.error('Failed to fetch memory health:', error);
    }
  };
  
  const fetchBotSessions = async (botId) => {
    try {
      const res = await fetch(`/api/bots/${botId}/sessions`);
      const json = await res.json();
      setBotSessions(json);
    } catch (error) {
      console.error('Failed to fetch sessions:', error);
    }
  };
  
  const fetchBotCronJobs = async (botId) => {
    try {
      const res = await fetch(`/api/bots/${botId}/cron-jobs`);
      const json = await res.json();
      setBotCronJobs(json);
    } catch (error) {
      console.error('Failed to fetch cron jobs:', error);
    }
  };

  const handleNodeAction = async (action) => {
    setActionLoading(true);
    try {
      let endpoint = '';
      let method = 'DELETE';
      let body = {};

      switch (action) {
        case 'backup':
          endpoint = `/api/nodes/${id}/backup`;
          break;
        case 'restore':
          if (!confirmDialog.data?.backup_id) {
            alert('è¯·å…ˆé€‰æ‹©è¦è¿˜åŸçš„å¤‡ä»½');
            return;
          }
          endpoint = `/api/nodes/${id}/restore`;
          body = { backup_id: confirmDialog.data.backup_id };
          break;
        case 'restart':
          endpoint = `/api/nodes/${id}/restart`;
          break;
        case 'test':
          endpoint = `/api/nodes/${id}/test`;
          break;
      
        case 'delete':
          endpoint = `/api/nodes/${id}/action`;
          method = 'DELETE';
          body = {};
          break;}

      const res = await fetch(endpoint, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: Object.keys(body).length > 0 ? JSON.stringify(body) : undefined
      });

      const result = await res.json();
      if (res.ok) {
        if (confirmDialog.action === 'delete') {
          alert('âœ… èŠ‚ç‚¹åˆ é™¤æˆåŠŸï¼Œå³å°†è¿”å›èŠ‚ç‚¹åˆ—è¡¨');
          // åˆ é™¤æˆåŠŸåè·³è½¬å›èŠ‚ç‚¹åˆ—è¡¨
          window.location.href = '/';
        } else {
          alert(result.message || 'âœ… æ“ä½œæˆåŠŸ');
          fetchNodeDetail();
        }
      } else {
        alert('âŒ æ“ä½œå¤±è´¥: ' + result.error);
      }
    } catch (error) {
      alert('âŒ æ“ä½œå¤±è´¥: ' + error.message);
    } finally {
      setActionLoading(false);
      setConfirmDialog({ isOpen: false, action: null, data: null });
    }
  };

  const handleSyncAgents = async () => {
    if (actionLoading) return;
    
    setActionLoading(true);
    try {
      const res = await fetch(`/api/nodes/${id}/sync-agents`, { method: 'POST' });
      const result = await res.json();
      
      if (res.ok) {
        alert(`âœ… AgentåŒæ­¥æˆåŠŸ: ${result.message}`);
        // é‡æ–°è·å–Botsä¿¡æ¯
        await fetchBots();
      } else {
        alert(`âŒ AgentåŒæ­¥å¤±è´¥: ${result.error}`);
      }
    } catch (error) {
      alert(`âŒ AgentåŒæ­¥å¤±è´¥: ${error.message}`);
    } finally {
      setActionLoading(false);
    }
  };

  const handleBotRestart = async (botId) => {
    setActionLoading(true);
    try {
      const res = await fetch(`/api/bots/${botId}/restart`, {
        method: 'POST'
      });
      const result = await res.json();
      if (res.ok) {
        alert(result.message || 'âœ… Bot å·²é‡å¯');
        fetchBots();
      } else {
        alert('âŒ é‡å¯å¤±è´¥: ' + result.error);
      }
    } catch (error) {
      alert('âŒ é‡å¯å¤±è´¥: ' + error.message);
    } finally {
      setActionLoading(false);
      setConfirmDialog({ isOpen: false, action: null, data: null });
    }
  };

  const handleVerifyKey = async (keyId) => {
    try {
      const res = await fetch(`/api/keys/${keyId}/verify`, { method: 'POST' });
      const result = await res.json();
      if (res.ok) {
        alert(`âœ… éªŒè¯å®Œæˆ\nçŠ¶æ€: ${result.status}`);
        fetchKeys();
      } else {
        alert('âŒ éªŒè¯å¤±è´¥: ' + result.error);
      }
    } catch (error) {
      alert('âŒ éªŒè¯å¤±è´¥: ' + error.message);
    }
  };

  const showImplementation = (type, itemId) => {
    const implementations = {
      backup: {
        feature: `å¤‡ä»½èŠ‚ç‚¹ ${id}`,
        description: 'SSH è¿æ¥åˆ°èŠ‚ç‚¹ï¼Œæ‰“åŒ…é…ç½®å’Œ workspaceï¼Œä¸Šä¼ åˆ° GitHub',
        steps: [
          `SSH è¿æ¥åˆ° ${node?.host}:${node?.port}`,
          'æ‰§è¡Œ ocm-agent backup (èŠ‚ç‚¹ä¸Šçš„ shell è„šæœ¬)',
          'æ‰“åŒ… ~/.openclaw/config/ é…ç½®æ–‡ä»¶',
          'æ‰“åŒ… ~/.openclaw/workspace/ å·¥ä½œåŒº',
          'ç”Ÿæˆ metadata.json (æ—¶é—´ã€æ–‡ä»¶æ•°ã€å¤§å°)',
          'SCP ä¸‹è½½åˆ° Master çš„ ocm-backups/nodes/${node?.id}/',
          `git add nodes/${id}/ && git commit -m "Backup ${id}"`,
          'git push åˆ° GitHub',
          'å¯é€‰ï¼šå‹ç¼©ä¸Šä¼ åˆ° Google Drive',
          'æ’å…¥å¤‡ä»½è®°å½•åˆ°æ•°æ®åº“',
          'å‘é€é€šçŸ¥åˆ° Bot'
        ],
        tech: ['ssh2', 'node-scp', 'simple-git', 'googleapis'],
        api: { method: 'POST', endpoint: `/api/nodes/${id}/backups` },
        note: 'å¤‡ä»½æ—¶é—´å–å†³äº workspace å¤§å°ï¼Œé€šå¸¸ 10-30 ç§’'
      },
      restore: {
        feature: `è¿˜åŸèŠ‚ç‚¹ ${id}`,
        description: 'ä» GitHub æ¢å¤é…ç½®åˆ°èŠ‚ç‚¹ï¼Œéœ€å…ˆé€‰æ‹©å¤‡ä»½ç‚¹',
        steps: [
          'ç”¨æˆ·é€‰æ‹©è¦è¿˜åŸçš„å¤‡ä»½ï¼ˆé€šè¿‡ tag æˆ– commit hashï¼‰',
          'âš ï¸ ç¡®è®¤æç¤ºï¼š"æ­¤æ“ä½œä¼šè¦†ç›–å½“å‰é…ç½®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ"',
          'åˆ›å»ºè¿˜åŸå‰å¿«ç…§ (rollback-pre)',
          'git clone æˆ– pull ocm-backups ä»“åº“',
          `ä» nodes/${id}/ ç›®å½•æå–æ–‡ä»¶`,
          'SSH è¿æ¥åˆ°èŠ‚ç‚¹',
          'systemctl stop openclaw (åœæ­¢æœåŠ¡)',
          'SCP ä¸Šä¼ æ–‡ä»¶åˆ° ~/.openclaw/',
          'chmod +x ~/.openclaw/bin/* (æ¢å¤æƒé™)',
          'systemctl start openclaw (é‡å¯æœåŠ¡)',
          'ç­‰å¾… 30s å¥åº·æ£€æŸ¥',
          'è§¦å‘æ™ºåŠ›æµ‹è¯•éªŒè¯æ•ˆæœ',
          'è®°å½•è¿˜åŸæ“ä½œåˆ°å®¡è®¡æ—¥å¿—'
        ],
        tech: ['ssh2', 'simple-git', 'node-scp', 'systemctl'],
        api: { method: 'POST', endpoint: `/api/nodes/${id}/restore` },
        note: 'è¿˜åŸåä¼šè‡ªåŠ¨è§¦å‘æ™ºåŠ›æµ‹è¯•ï¼Œç¡®ä¿èŠ‚ç‚¹æ¢å¤æ­£å¸¸'
      },
      restart: {
        feature: `é‡å¯èŠ‚ç‚¹ ${id}`,
        description: 'é€šè¿‡ SSH é‡å¯ OpenClaw æœåŠ¡',
        steps: [
          `SSH è¿æ¥åˆ° ${node?.host}`,
          'æ‰§è¡Œ systemctl restart openclaw',
          'ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆæœ€å¤š 30sï¼‰',
          'æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼šsystemctl is-active openclaw',
          'å¦‚æœå¤±è´¥ï¼Œå°è¯• kill è¿›ç¨‹åé‡å¯',
          'æ›´æ–°èŠ‚ç‚¹çŠ¶æ€ä¸º online/offline',
          'è®°å½•åˆ°äº‹ä»¶æ—¥å¿—',
          'å‘é€é€šçŸ¥'
        ],
        tech: ['ssh2', 'systemctl'],
        api: { method: 'POST', endpoint: `/api/nodes/${id}/restart` },
        note: 'é‡å¯ä¼šä¸­æ–­æ­£åœ¨è¿›è¡Œçš„å¯¹è¯ï¼Œè°¨æ…æ“ä½œ'
      },
      test: {
        feature: `æ™ºåŠ›æµ‹è¯• ${id}`,
        description: 'å‘é€æµ‹è¯•é¢˜åˆ°èŠ‚ç‚¹ï¼Œç”± LLM-as-Judge è¯„åˆ†',
        steps: [
          'ä»æµ‹è¯•é¢˜åº“éšæœºæŠ½å– 5 é“é¢˜ï¼ˆæ¯ç»´åº¦ 1 é“ï¼‰',
          'é€šè¿‡èŠ‚ç‚¹çš„ Bot å‘é€æµ‹è¯•æ¶ˆæ¯',
          'è®°å½•å“åº”æ—¶é—´å’Œå†…å®¹',
          'LLM Judge (GPT-4) è¯„åˆ†ï¼š',
          '  - è®°å¿†ä¸€è‡´æ€§ (æ£€æŸ¥ MEMORY.md å¼•ç”¨) /20',
          '  - é€»è¾‘æ¨ç† (å¤šæ­¥æ¨ç†é¢˜) /20',
          '  - å·¥å…·ä½¿ç”¨ (éœ€è¦è°ƒç”¨å·¥å…·çš„ä»»åŠ¡) /20',
          '  - å›å¤è´¨é‡ (è¯­è¨€æµç•…åº¦ã€å‡†ç¡®æ€§) /20',
          '  - äººæ ¼ä¸€è‡´æ€§ (ä¸ SOUL.md å¯¹æ¯”) /20',
          'æ±‡æ€»æ€»åˆ† /100',
          'å¦‚æœ < 80 åˆ†ï¼Œè§¦å‘å‘Šè­¦',
          'å¦‚æœ < 60 åˆ†ï¼Œå»ºè®®è‡ªåŠ¨å›æ»š',
          'ä¿å­˜è¯„åˆ†åˆ°æ•°æ®åº“',
          'æ›´æ–°èŠ‚ç‚¹ last_score'
        ],
        tech: ['telegram-bot', 'openai', 'anthropic', 'sqlite3'],
        api: { method: 'POST', endpoint: `/api/nodes/${id}/test` },
        note: 'æµ‹è¯•ä¼šæ¶ˆè€—çº¦ $0.05-0.10 çš„ AI è´¹ç”¨'
      },
      restoreVersion: {
        feature: `è¿˜åŸåˆ°æ­¤ç‰ˆæœ¬`,
        description: 'å¿«é€Ÿè¿˜åŸåˆ°é€‰å®šçš„å¤‡ä»½ç‰ˆæœ¬',
        steps: [
          'è¯»å–å¤‡ä»½çš„ git_commit æˆ– git_tag',
          'è°ƒç”¨è¿˜åŸ API',
          '(åŒ restore æµç¨‹)'
        ],
        tech: ['ssh2', 'simple-git', 'systemctl'],
        api: { method: 'POST', endpoint: `/api/nodes/${id}/restore` },
        note: 'ä¼šå…ˆåˆ›å»ºå½“å‰å¿«ç…§å†è¿˜åŸ'
      },
      restartBot: {
        feature: `é‡å¯ Bot ${itemId}`,
        description: 'SSH é‡å¯èŠ‚ç‚¹ä¸Šçš„ Bot è¿›ç¨‹',
        steps: [
          `SSH è¿æ¥åˆ° ${node?.host}`,
          'æŸ¥æ‰¾ Bot è¿›ç¨‹ï¼šps aux | grep openclaw | grep <workspace>',
          'kill -15 <pid> (ä¼˜é›…åœæ­¢)',
          'ç­‰å¾… 5s',
          'å¦‚æœæœªåœæ­¢ï¼Œkill -9 <pid> (å¼ºåˆ¶åœæ­¢)',
          'é‡æ–°å¯åŠ¨ Bot: openclaw start --workspace <path>',
          'æ›´æ–° Bot çŠ¶æ€ä¸º running',
          'è®°å½•æ“ä½œ'
        ],
        tech: ['ssh2', 'ps', 'kill', 'openclaw-cli'],
        api: { method: 'POST', endpoint: `/api/bots/${itemId}/restart` },
        note: 'Bot ä¼šè¯ä¼šä¸¢å¤±ï¼Œéœ€è¦ç”¨æˆ·é‡æ–°å‘èµ·å¯¹è¯'
      },
      stopBot: {
        feature: `åœæ­¢ Bot ${itemId}`,
        description: 'SSH åœæ­¢èŠ‚ç‚¹ä¸Šçš„ Bot è¿›ç¨‹',
        steps: [
          `SSH è¿æ¥åˆ° ${node?.host}`,
          'æŸ¥æ‰¾ Bot è¿›ç¨‹',
          'kill -15 <pid>',
          'ç­‰å¾… 5s ç¡®è®¤åœæ­¢',
          'æ›´æ–° Bot çŠ¶æ€ä¸º stopped'
        ],
        tech: ['ssh2', 'kill'],
        api: { method: 'POST', endpoint: `/api/bots/${itemId}/stop` },
        note: 'åœæ­¢åéœ€è¦æ‰‹åŠ¨é‡å¯æˆ–é€šè¿‡ OCM é‡å¯'
      },
      addKey: {
        feature: 'æ·»åŠ  API Key',
        description: 'è¾“å…¥ Key ä¿¡æ¯ï¼Œå­˜å…¥æ•°æ®åº“ï¼Œå¹¶åŒæ­¥åˆ°èŠ‚ç‚¹é…ç½®',
        steps: [
          'ç”¨æˆ·è¾“å…¥ï¼šprovider, key_name, api_key, monthly_limit',
          'æ’å…¥åˆ°æ•°æ®åº“ api_keys è¡¨',
          'SSH è¿æ¥åˆ°èŠ‚ç‚¹',
          'è¯»å– ~/.openclaw/config.yaml',
          'æ·»åŠ æˆ–æ›´æ–° keys å­—æ®µ',
          'å†™å›é…ç½®æ–‡ä»¶',
          'systemctl reload openclaw (çƒ­é‡è½½)',
          'éªŒè¯ Key æœ‰æ•ˆæ€§ (å¯é€‰)',
          'å‘é€é€šçŸ¥'
        ],
        tech: ['sqlite3', 'ssh2', 'yaml', 'systemctl'],
        api: { method: 'POST', endpoint: `/api/nodes/${id}/keys` },
        note: 'Key ä¼šåŠ å¯†å­˜å‚¨ï¼Œä¼ è¾“æ—¶ä½¿ç”¨ SSH'
      }
    };

    const impl = implementations[type];
    if (impl) {
      setModalData(impl);
      setModalOpen(true);
    }
  };

  if (loading) {
    return <div className="text-center py-8 text-gray-500">åŠ è½½ä¸­...</div>;
  }

  if (!data || !data.node) {
    return <div className="text-center py-8 text-red-500">èŠ‚ç‚¹ä¸å­˜åœ¨</div>;
  }

  const { node, backups, scores, events } = data;

  return (
    <div className="space-y-6 pb-20 md:pb-0">
      <Link to="/nodes" className="inline-flex items-center text-blue-400 hover:text-blue-300">
        â† è¿”å›èŠ‚ç‚¹åˆ—è¡¨
      </Link>

      {/* èŠ‚ç‚¹æ ‡é¢˜å¡ç‰‡ */}
      <div className="bg-gray-800 rounded-lg border border-gray-700 p-6 shadow-lg">
        <div className="flex items-center justify-between mb-4">
          <div>
            <h1 className="text-2xl font-bold text-white">{node.id}</h1>
            <p className="text-gray-400">{node.name}</p>
          </div>
          <div className={`px-4 py-2 rounded-full text-sm font-medium ${
            node.status === 'online' ? 'bg-green-900/30 text-green-400 border border-green-700' :
            'bg-red-900/30 text-red-400 border border-red-700'
          }`}>
            {node.status === 'online' ? 'ğŸŸ¢ åœ¨çº¿' : 'ğŸ”´ ç¦»çº¿'}
          </div>
        </div>

        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div>
            <div className="text-sm text-gray-400">CPU ä½¿ç”¨ç‡</div>
            <div className="text-2xl font-bold text-white">{node.cpu_usage}%</div>
          </div>
          <div>
            <div className="text-sm text-gray-400">RAM ä½¿ç”¨ç‡</div>
            <div className="text-2xl font-bold text-white">{node.ram_usage}%</div>
          </div>
          <div>
            <div className="text-sm text-gray-400">æ™ºåŠ›è¯„åˆ†</div>
            <div className={`text-2xl font-bold ${
              node.last_score >= 90 ? 'text-green-400' :
              node.last_score >= 70 ? 'text-yellow-400' :
              'text-red-400'
            }`}>
              ğŸ§  {node.last_score || '-'}
            </div>
          </div>
          <div>
            <div className="text-sm text-gray-400">OpenClaw ç‰ˆæœ¬</div>
            <div className="text-xl font-semibold text-white">{node.openclaw_version}</div>
          </div>
        </div>
      </div>

      {/* Tabs */}
      <div className="bg-gray-800 rounded-lg border border-gray-700 shadow-lg">
        <div className="border-b border-gray-700 overflow-x-auto">
          <nav className="flex -mb-px">
            {[
              { key: 'overview', label: 'ğŸ“Š æ¦‚è§ˆ' },
              { key: 'keys', label: 'ğŸ”‘ Keys' },
              { key: 'bots', label: 'ğŸ¤– Bots' },
              { key: 'skills', label: 'ğŸ› ï¸ Skills' },
              { key: 'config', label: 'âš™ï¸ Config' },
              { key: 'backups', label: 'ğŸ“¦ å¤‡ä»½' },
              { key: 'scores', label: 'ğŸ§  æ™ºåŠ›' },
              { key: 'events', label: 'ğŸ“‹ äº‹ä»¶' },
            ].map(t => (
              <button
                key={t.key}
                onClick={() => setTab(t.key)}
                className={`px-4 md:px-6 py-3 text-xs md:text-sm font-medium whitespace-nowrap ${
                  tab === t.key
                    ? 'border-b-2 border-blue-600 text-blue-400'
                    : 'text-gray-400 hover:text-gray-300'
                }`}
              >
                {t.label}
              </button>
            ))}
          </nav>
        </div>

        <div className="p-4 md:p-6">
          {/* Overview Tab */}
          {tab === 'overview' && (
            <div className="space-y-4">
              <div>
                <h3 className="font-semibold text-white mb-2">åŸºæœ¬ä¿¡æ¯</h3>
                <div className="space-y-1 text-sm">
                  <div className="flex justify-between">
                    <span className="text-gray-400">IP åœ°å€:</span>
                    <span className="text-white">{node.host}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">SSH ç«¯å£:</span>
                    <span className="text-white">{node.port}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">SSH ç”¨æˆ·:</span>
                    <span className="text-white">{node.ssh_user}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">OpenClaw è·¯å¾„:</span>
                    <span className="text-xs text-white break-all">{node.openclaw_path}</span>
                  </div>
                </div>
              </div>

              {/* Quick Actions */}
              <div>
                <h3 className="font-semibold text-white mb-2">å¿«æ·æ“ä½œ</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                  <button
                    onClick={() => setConfirmDialog({
                      isOpen: true,
                      action: 'backup',
                      data: null
                    })}
                    disabled={actionLoading}
                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded transition-colors disabled:opacity-50"
                  >
                    ğŸ’¾ å¤‡ä»½
                  </button>
                  <button
                    onClick={handleRestoreNavigation}
                    disabled={actionLoading}
                    className="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded transition-colors disabled:opacity-50"
                    title="è·³è½¬åˆ°å¤‡ä»½é¡µé¢é€‰æ‹©è¦è¿˜åŸçš„å¤‡ä»½"
                  >
                    ğŸ”„ è¿˜åŸ
                  </button>
                  <button
                    onClick={() => setConfirmDialog({
                      isOpen: true,
                      action: 'restart',
                      data: null
                    })}
                    disabled={actionLoading}
                    className="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white text-sm rounded transition-colors disabled:opacity-50"
                  >
                    âš¡ é‡å¯
                  </button>
                  <button
                    onClick={() => setConfirmDialog({
                      isOpen: true,
                      action: 'test',
                      data: null
                    })}
                    disabled={actionLoading}
                    className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded transition-colors disabled:opacity-50"
                  >
                    ğŸ§  æ™ºåŠ›æµ‹è¯•
                  </button>
                  <button                    onClick={() => setConfirmDialog({                      isOpen: true,                      action: 'delete',                      data: null                    })}                    disabled={actionLoading}                    className="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition-colors disabled:opacity-50"                  >                    ğŸ—‘ï¸ é€€å½¹                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Keys Tab */}
          {tab === 'keys' && (
            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <h3 className="font-semibold text-white">API Keys</h3>
                <button 
                  onClick={() => showImplementation('addKey')}
                  className="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
                >
                  + æ·»åŠ Key
                </button>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead className="bg-gray-900 text-xs text-gray-400 uppercase border-b border-gray-700">
                    <tr>
                      <th className="px-3 md:px-4 py-2 text-left">Provider</th>
                      <th className="px-3 md:px-4 py-2 text-left">åç§°</th>
                      <th className="px-3 md:px-4 py-2 text-left hidden md:table-cell">Key</th>
                      <th className="px-3 md:px-4 py-2 text-center">çŠ¶æ€</th>
                      <th className="px-3 md:px-4 py-2 text-right hidden lg:table-cell">ç”¨é‡/é™é¢</th>
                      <th className="px-3 md:px-4 py-2 text-right">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-700">
                    {keys.map(key => (
                      <tr key={key.id} className="hover:bg-gray-700/50">
                        <td className="px-3 md:px-4 py-3">
                          <span className={`text-xs px-2 py-1 rounded ${getProviderColor(key.provider)}`}>
                            {getProviderName(key.provider)}
                          </span>
                        </td>
                        <td className="px-3 md:px-4 py-3 text-white">{key.key_name}</td>
                        <td className="px-3 md:px-4 py-3 font-mono text-xs text-gray-400 hidden md:table-cell">
                          {maskKey(key.api_key)}
                        </td>
                        <td className="px-3 md:px-4 py-3 text-center text-lg">
                          {getStatusIcon(key.status)}
                        </td>
                        <td className="px-3 md:px-4 py-3 text-xs text-right text-white hidden lg:table-cell">
                          {key.monthly_limit ? (
                            <span>${key.monthly_used?.toFixed(0) || '0'} / ${key.monthly_limit}</span>
                          ) : '-'}
                        </td>
                        <td className="px-3 md:px-4 py-3 text-right">
                          <button
                            onClick={() => handleVerifyKey(key.id)}
                            className="text-blue-400 hover:text-blue-300 text-xs"
                          >
                            éªŒè¯
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {/* Bots Tab - Phase 7 Enhanced */}
          {tab === 'bots' && (
            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <h3 className="font-semibold text-white">Bots & Agents</h3>
                <div className="flex space-x-2">
                  <button 
                    onClick={handleSyncAgents}
                    disabled={actionLoading}
                    className="px-3 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700 disabled:opacity-50"
                  >
                    ğŸ”„ åŒæ­¥Agent
                  </button>
                  <button 
                    onClick={() => setShowAddBotModal(true)}
                    className="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700"
                  >
                    + æ·»åŠ Bot
                  </button>
                </div>
              </div>

              <div className="grid grid-cols-1 gap-4">
                {bots.map(bot => {
                  const isSelected = selectedBotId === bot.id;
                  const latestMemory = botMemoryHealth.length > 0 ? botMemoryHealth[0] : null;
                  const activeSessions = botSessions.filter(s => s.is_active).length;
                  const enabledCrons = botCronJobs.filter(c => c.enabled).length;
                  
                  return (
                    <div key={bot.id} className="bg-gray-900 border border-gray-700 rounded-lg p-6 shadow-lg">
                      {/* Bot Header */}
                      <div className="flex items-start justify-between mb-3">
                        <div className="flex items-center space-x-3">
                          <span className="text-2xl">ğŸ¤–</span>
                          <div>
                            <div className="font-bold text-lg text-white">
                              {bot.name || bot.bot_name || bot.agent_id}
                            </div>
                            <div className="text-sm text-gray-400">
                              Agent ID: {bot.agent_id || 'unknown'}
                            </div>
                            {bot.description && (
                              <div className="text-xs text-gray-500 mt-1">{bot.description}</div>
                            )}
                          </div>
                        </div>
                        <div className="flex items-center space-x-2">
                          <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                            bot.status === 'running' ? 'bg-green-900/30 text-green-400' :
                            bot.status === 'stopped' ? 'bg-red-900/30 text-red-400' :
                            'bg-yellow-900/30 text-yellow-400'
                          }`}>
                            {bot.status}
                          </span>
                        </div>
                      </div>

                      {/* Agent Identity */}
                      {bot.user_name && (
                        <div className="mb-3 p-2 bg-gray-50 rounded text-xs">
                          <div className="text-gray-500 mb-1">Agent for:</div>
                          <div className="font-medium text-gray-900">{bot.user_name}</div>
                          {bot.soul_summary && (
                            <div className="text-gray-600 mt-1">{bot.soul_summary}</div>
                          )}
                        </div>
                      )}

                      {/* Stats Grid */}
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mb-4">
                        <div className="p-3 bg-gray-800 border border-gray-700 rounded-lg">
                          <div className="text-gray-400 text-xs">Sessions</div>
                          <div className="font-semibold text-white text-lg">
                            {isSelected ? `${activeSessions}/${botSessions.length}` : bot.session_count || 0}
                          </div>
                        </div>
                        <div className="p-3 bg-gray-800 border border-gray-700 rounded-lg">
                          <div className="text-gray-400 text-xs">Cron Jobs</div>
                          <div className="font-semibold text-white text-lg">
                            {isSelected ? `${enabledCrons}/${botCronJobs.length}` : bot.cron_count || 0}
                          </div>
                        </div>
                        <div className="p-3 bg-gray-800 border border-gray-700 rounded-lg">
                          <div className="text-gray-400 text-xs">Memory</div>
                          <div className={`font-semibold text-lg ${
                            latestMemory?.health_status === 'healthy' ? 'text-green-400' :
                            latestMemory?.health_status === 'warning' ? 'text-yellow-400' :
                            'text-white'
                          }`}>
                            {isSelected && latestMemory ? (
                              <>
                                {(latestMemory.total_memory_size / 1024).toFixed(0)}KB
                                {latestMemory.health_status === 'warning' && ' âš ï¸'}
                              </>
                            ) : '-'}
                          </div>
                        </div>
                        <div className="p-3 bg-gray-800 border border-gray-700 rounded-lg">
                          <div className="text-gray-400 text-xs">Model</div>
                          <div className="font-semibold text-white text-sm truncate">
                            {bot.model?.split('/')[1] || 'claude-sonnet-4'}
                          </div>
                        </div>
                      </div>

                      {/* Workspace Files */}
                      {bot.workspace_files && (
                        <div className="mb-3 text-xs">
                          <div className="text-gray-500 mb-1">Workspace Files:</div>
                          <div className="flex flex-wrap gap-1">
                            {JSON.parse(bot.workspace_files || '[]').map((file, idx) => (
                              <span key={idx} className="px-2 py-0.5 bg-blue-50 text-blue-600 rounded">
                                {file}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Expandable Details */}
                      {isSelected && (
                        <div className="mt-3 pt-3 border-t border-gray-200 space-y-3">
                          {/* Sessions */}
                          <div>
                            <div className="text-xs font-medium text-gray-700 mb-1">
                              Sessions ({botSessions.length})
                            </div>
                            <div className="space-y-1">
                              {botSessions.slice(0, 3).map(session => (
                                <div key={session.id} className="flex items-center justify-between text-xs bg-gray-50 px-2 py-1 rounded">
                                  <span className="flex items-center space-x-1">
                                    <span>{session.session_type === 'main' ? 'ğŸ’¬' : session.session_type === 'cron' ? 'â°' : 'ğŸ”€'}</span>
                                    <span>{session.display_name}</span>
                                  </span>
                                  <span className={session.is_active ? 'text-green-600' : 'text-gray-400'}>
                                    {session.is_active ? 'â—' : 'â—‹'}
                                  </span>
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Cron Jobs */}
                          <div>
                            <div className="text-xs font-medium text-gray-700 mb-1">
                              Cron Jobs ({botCronJobs.length})
                            </div>
                            <div className="space-y-1">
                              {botCronJobs.slice(0, 3).map(job => (
                                <div key={job.id} className="flex items-center justify-between text-xs bg-gray-50 px-2 py-1 rounded">
                                  <span className="truncate">{job.job_name}</span>
                                  <span className={job.enabled ? 'text-green-600' : 'text-gray-400'}>
                                    {job.enabled ? 'âœ…' : 'â¸ï¸'}
                                  </span>
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Memory Health */}
                          {latestMemory && latestMemory.health_status === 'warning' && (
                            <div className="text-xs p-2 bg-yellow-50 border border-yellow-200 rounded">
                              <div className="font-medium text-yellow-800 mb-1">âš ï¸ Memory Warning</div>
                              {JSON.parse(latestMemory.issues || '[]').map((issue, idx) => (
                                <div key={idx} className="text-yellow-700">{issue}</div>
                              ))}
                            </div>
                          )}
                        </div>
                      )}

                      {/* Actions */}
                      <div className="flex justify-between items-center mt-4 pt-3 border-t border-gray-700">
                        <div className="text-xs text-gray-400">
                          æœ€åæ›´æ–°: {new Date(bot.updated_at).toLocaleString('zh-CN')}
                        </div>
                        <div className="flex space-x-2">
                          <button
                            onClick={() => setSelectedBotId(isSelected ? null : bot.id)}
                            className="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded transition-colors"
                          >
                            {isSelected ? 'æ”¶èµ· â–²' : 'è¯¦æƒ… â–¼'}
                          </button>
                          <button 
                            onClick={() => setConfirmDialog({
                              isOpen: true,
                              action: 'restart-bot',
                              data: { botId: bot.id, botName: bot.name }
                            })}
                            disabled={actionLoading}
                            className="px-3 py-1.5 bg-orange-600 hover:bg-orange-700 text-white text-xs rounded transition-colors disabled:opacity-50"
                          >
                            ğŸ”„ é‡å¯
                          </button>
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* Skills Tab - Phase 7 */}
          {tab === 'skills' && (
            <div className="space-y-4">
              <div className="flex justify-between items-center mb-4">
                <h3 className="font-semibold">Skills & Tools</h3>
                <div className="text-sm text-gray-600">
                  {skills.filter(s => s.source === 'bundled').length} bundled + {' '}
                  {skills.filter(s => s.source === 'custom' || s.source === 'workspace').length} custom
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {skills.map(skill => (
                  <div key={skill.id} className="border border-gray-200 rounded-lg p-3">
                    <div className="flex items-start justify-between mb-2">
                      <div className="flex items-center space-x-2">
                        <span className="text-xl">
                          {skill.source === 'bundled' ? 'ğŸ“¦' : 'âš™ï¸'}
                        </span>
                        <div>
                          <div className="font-semibold text-gray-900">{skill.skill_name}</div>
                          <div className="text-xs text-gray-500">{skill.source}</div>
                        </div>
                      </div>
                      {skill.version && (
                        <span className="text-xs px-2 py-0.5 bg-gray-100 rounded">
                          {skill.version}
                        </span>
                      )}
                    </div>
                    {skill.description && (
                      <div className="text-xs text-gray-600 mb-2">{skill.description}</div>
                    )}
                    <div className="text-xs text-gray-400 break-all">
                      {skill.skill_path}
                    </div>
                  </div>
                ))}
              </div>

              {skills.length === 0 && (
                <div className="text-center py-8 text-gray-400">æš‚æ— Skills</div>
              )}
            </div>
          )}

          {/* Config Tab - Phase 7 */}
          {tab === 'config' && (
            <div className="space-y-4">
              <h3 className="font-semibold">Gateway Configuration</h3>

              {gatewayConfig && gatewayConfig.node_id ? (
                <>
                  {/* Channels */}
                  <div>
                    <div className="text-sm font-medium text-gray-700 mb-2">Channels</div>
                    <div className="flex flex-wrap gap-2">
                      {['telegram', 'discord', 'whatsapp', 'slack'].map(ch => {
                        const channels = JSON.parse(gatewayConfig.channels || '[]');
                        const enabled = channels.includes(ch);
                        return (
                          <div
                            key={ch}
                            className={`px-3 py-2 rounded text-sm font-medium ${
                              enabled
                                ? 'bg-green-100 text-green-700 border border-green-300'
                                : 'bg-gray-100 text-gray-400 border border-gray-200'
                            }`}
                          >
                            {ch.charAt(0).toUpperCase() + ch.slice(1)} {enabled ? 'âœ…' : 'âŒ'}
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {/* Model */}
                  <div>
                    <div className="text-sm font-medium text-gray-700 mb-2">Default Model</div>
                    <div className="px-3 py-2 bg-gray-50 border border-gray-200 rounded text-sm font-mono">
                      {gatewayConfig.default_model || '-'}
                    </div>
                  </div>

                  {/* Heartbeat */}
                  <div>
                    <div className="text-sm font-medium text-gray-700 mb-2">Heartbeat</div>
                    <div className="flex items-center space-x-3">
                      <div className={`px-3 py-2 rounded text-sm font-medium ${
                        gatewayConfig.heartbeat_enabled
                          ? 'bg-green-100 text-green-700 border border-green-300'
                          : 'bg-gray-100 text-gray-400 border border-gray-200'
                      }`}>
                        {gatewayConfig.heartbeat_enabled ? 'âœ… Enabled' : 'âŒ Disabled'}
                      </div>
                      {gatewayConfig.heartbeat_enabled && gatewayConfig.heartbeat_interval && (
                        <div className="text-sm text-gray-600">
                          Interval: <span className="font-medium">{gatewayConfig.heartbeat_interval}</span>
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Workspace Path */}
                  <div>
                    <div className="text-sm font-medium text-gray-700 mb-2">Agent Workspace</div>
                    <div className="px-3 py-2 bg-gray-50 border border-gray-200 rounded text-xs font-mono break-all">
                      {gatewayConfig.agent_workspace || '-'}
                    </div>
                  </div>

                  {/* JSON Preview */}
                  <div>
                    <div className="text-sm font-medium text-gray-700 mb-2">Config JSON</div>
                    <pre className="px-3 py-2 bg-gray-900 text-gray-100 rounded text-xs overflow-x-auto">
                      {gatewayConfig.config_json ? JSON.stringify(JSON.parse(gatewayConfig.config_json), null, 2) : '{}'}
                    </pre>
                  </div>

                  {/* Fetched At */}
                  <div className="text-xs text-gray-500">
                    Last fetched: {new Date(gatewayConfig.fetched_at).toLocaleString('zh-CN')}
                  </div>
                </>
              ) : (
                <div className="text-center py-8 text-gray-400">é…ç½®æœªåŠ è½½</div>
              )}
            </div>
          )}

          {/* Backups Tab */}
          {tab === 'backups' && (
            <div className="space-y-2">
              {backups.length === 0 ? (
                <div className="text-center py-8 text-gray-400">æš‚æ— å¤‡ä»½</div>
              ) : (
                backups.slice((backupsPage - 1) * pageSize, backupsPage * pageSize).map(backup => (
                  <div key={backup.id} className="border border-gray-200 rounded p-3">
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center space-x-2">
                        <span className="text-xs px-2 py-1 bg-gray-100 rounded">{backup.type}</span>
                        {backup.is_stable && (
                          <span className="text-xs px-2 py-1 bg-green-100 text-green-800 rounded">âœ… stable</span>
                        )}
                        {backup.score && (
                          <span className={`text-xs px-2 py-1 rounded ${
                            backup.score >= 90 ? 'bg-green-100 text-green-800' :
                            backup.score >= 70 ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                          }`}>
                            ğŸ§  {backup.score}
                          </span>
                        )}
                      </div>
                      <div className="text-xs text-gray-400">
                        {new Date(backup.created_at).toLocaleString('zh-CN')}
                      </div>
                    </div>
                    <div className="text-xs text-gray-500 space-y-1">
                      {backup.git_tag && <div>Tag: {backup.git_tag}</div>}
                      <div>Commit: {backup.git_commit?.substring(0, 8)}</div>
                      <div>{backup.file_count} æ–‡ä»¶ Â· {(backup.total_size / 1024 / 1024).toFixed(2)} MB</div>
                    </div>
                    <button
                      onClick={() => showImplementation('restoreVersion', backup.id)}
                      className="mt-2 px-3 py-1 bg-green-50 text-green-600 text-xs rounded hover:bg-green-100"
                    >
                      ğŸ”„ è¿˜åŸåˆ°æ­¤ç‰ˆæœ¬
                    </button>
                  </div>
                ))
              )}
              
              {/* å¤‡ä»½åˆ†é¡µ */}
              {backups.length > pageSize && (
                <div className="flex items-center justify-between mt-4 pt-4 border-t border-gray-200 text-sm text-gray-600">
                  <span>å…± {backups.length} æ¡ï¼Œç¬¬ {backupsPage}/{Math.ceil(backups.length / pageSize)} é¡µ</span>
                  <div className="flex gap-2">
                    <button 
                      onClick={() => setBackupsPage(p => Math.max(1, p - 1))}
                      disabled={backupsPage === 1}
                      className="px-3 py-1 bg-gray-50 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    >ä¸Šä¸€é¡µ</button>
                    <button
                      onClick={() => setBackupsPage(p => Math.min(Math.ceil(backups.length / pageSize), p + 1))}
                      disabled={backupsPage === Math.ceil(backups.length / pageSize)}
                      className="px-3 py-1 bg-gray-50 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    >ä¸‹ä¸€é¡µ</button>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Scores Tab */}
          {tab === 'scores' && (
            <div className="space-y-2">
              {scores.length === 0 ? (
                <div className="text-center py-8 text-gray-400">æš‚æ— è¯„åˆ†</div>
              ) : (
                scores.slice((scoresPage - 1) * pageSize, scoresPage * pageSize).map(score => (
                  <div key={score.id} className="border border-gray-200 rounded p-4">
                    <div className="flex items-center justify-between mb-3">
                      <div className={`text-2xl font-bold ${
                        score.total_score >= 90 ? 'text-green-600' :
                        score.total_score >= 70 ? 'text-yellow-600' :
                        'text-red-600'
                      }`}>
                        ğŸ§  {score.total_score}
                      </div>
                      <div className="text-xs text-gray-400">
                        {new Date(score.created_at).toLocaleString('zh-CN')}
                      </div>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-5 gap-2 text-xs">
                      <div>
                        <div className="text-gray-500">è®°å¿†</div>
                        <div className="font-medium">{score.memory_score}/20</div>
                      </div>
                      <div>
                        <div className="text-gray-500">é€»è¾‘</div>
                        <div className="font-medium">{score.logic_score}/20</div>
                      </div>
                      <div>
                        <div className="text-gray-500">å·¥å…·</div>
                        <div className="font-medium">{score.tool_score}/20</div>
                      </div>
                      <div>
                        <div className="text-gray-500">è´¨é‡</div>
                        <div className="font-medium">{score.quality_score}/20</div>
                      </div>
                      <div>
                        <div className="text-gray-500">äººæ ¼</div>
                        <div className="font-medium">{score.personality_score}/20</div>
                      </div>
                    </div>
                    {score.action_taken !== 'none' && (
                      <div className="mt-2 text-xs px-2 py-1 bg-orange-100 text-orange-800 rounded">
                        âš ï¸ {score.action_taken}
                      </div>
                    )}
                  </div>
                ))
              )}
              
              {/* è¯„åˆ†åˆ†é¡µ */}
              {scores.length > pageSize && (
                <div className="flex items-center justify-between mt-4 pt-4 border-t border-gray-200 text-sm text-gray-600">
                  <span>å…± {scores.length} æ¡ï¼Œç¬¬ {scoresPage}/{Math.ceil(scores.length / pageSize)} é¡µ</span>
                  <div className="flex gap-2">
                    <button 
                      onClick={() => setScoresPage(p => Math.max(1, p - 1))}
                      disabled={scoresPage === 1}
                      className="px-3 py-1 bg-gray-50 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    >ä¸Šä¸€é¡µ</button>
                    <button
                      onClick={() => setScoresPage(p => Math.min(Math.ceil(scores.length / pageSize), p + 1))}
                      disabled={scoresPage === Math.ceil(scores.length / pageSize)}
                      className="px-3 py-1 bg-gray-50 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    >ä¸‹ä¸€é¡µ</button>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Events Tab */}
          {tab === 'events' && (
            <div className="space-y-2">
              {events.length === 0 ? (
                <div className="text-center py-8 text-gray-400">æš‚æ— äº‹ä»¶</div>
              ) : (
                events.slice((eventsPage - 1) * pageSize, eventsPage * pageSize).map(event => (
                  <div key={event.id} className="flex items-start space-x-3 text-sm py-2 border-b border-gray-100 last:border-0">
                    <span className={`flex-shrink-0 ${
                      event.severity === 'error' ? 'text-red-500' :
                      event.severity === 'warn' ? 'text-orange-500' :
                      'text-gray-400'
                    }`}>
                      {event.severity === 'error' ? 'ğŸ”´' :
                       event.severity === 'warn' ? 'âš ï¸' :
                       'â„¹ï¸'}
                    </span>
                    <div className="flex-1">
                      <div className="text-gray-700">{event.message}</div>
                      <div className="text-xs text-gray-400 mt-1">
                        {new Date(event.created_at).toLocaleString('zh-CN')}
                      </div>
                    </div>
                  </div>
                ))
              )}
              
              {/* äº‹ä»¶åˆ†é¡µ */}
              {events.length > pageSize && (
                <div className="flex items-center justify-between mt-4 pt-4 border-t border-gray-200 text-sm text-gray-600">
                  <span>å…± {events.length} æ¡ï¼Œç¬¬ {eventsPage}/{Math.ceil(events.length / pageSize)} é¡µ</span>
                  <div className="flex gap-2">
                    <button 
                      onClick={() => setEventsPage(p => Math.max(1, p - 1))}
                      disabled={eventsPage === 1}
                      className="px-3 py-1 bg-gray-50 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    >ä¸Šä¸€é¡µ</button>
                    <button
                      onClick={() => setEventsPage(p => Math.min(Math.ceil(events.length / pageSize), p + 1))}
                      disabled={eventsPage === Math.ceil(events.length / pageSize)}
                      className="px-3 py-1 bg-gray-50 rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    >ä¸‹ä¸€é¡µ</button>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>

      {/* Implementation Modal */}
      <ImplementationModal
        isOpen={modalOpen}
        onClose={() => setModalOpen(false)}
        data={modalData}
      />

      {/* Add Bot Modal */}
      <AddBotModal
        isOpen={showAddBotModal}
        onClose={() => setShowAddBotModal(false)}
        onSuccess={fetchBots}
        nodeId={id}
      />

      {/* Confirm Dialog */}
      <ConfirmDialog
        isOpen={confirmDialog.isOpen}
        onClose={() => setConfirmDialog({ isOpen: false, action: null, data: null })}
        onConfirm={() => {
          if (confirmDialog.action === 'restart-bot') {
            handleBotRestart(confirmDialog.data.botId);
          } else {
            handleNodeAction(confirmDialog.action);
          }
        }}
        title={
          confirmDialog.action === 'backup' ? 'ç¡®è®¤å¤‡ä»½' :
          confirmDialog.action === 'restart' ? 'ç¡®è®¤é‡å¯' :
          confirmDialog.action === 'test' ? 'ç¡®è®¤æµ‹è¯•' :
          confirmDialog.action === 'delete' ? 'ç¡®è®¤åˆ é™¤èŠ‚ç‚¹' :
          confirmDialog.action === 'restart-bot' ? 'ç¡®è®¤é‡å¯ Bot' :
          'ç¡®è®¤æ“ä½œ'
        }
        message={
          confirmDialog.action === 'backup' ? `ç¡®å®šè¦å¤‡ä»½èŠ‚ç‚¹ ${id} å—ï¼Ÿ` :
          confirmDialog.action === 'restart' ? `ç¡®å®šè¦é‡å¯èŠ‚ç‚¹ ${id} å—ï¼Ÿè¿™ä¼šä¸­æ–­æ­£åœ¨è¿›è¡Œçš„ä¼šè¯ã€‚` :
          confirmDialog.action === 'test' ? `ç¡®å®šè¦å¯¹èŠ‚ç‚¹ ${id} è¿›è¡Œæ™ºåŠ›æµ‹è¯•å—ï¼Ÿé¢„è®¡éœ€è¦ 1-2 åˆ†é’Ÿã€‚` :
          confirmDialog.action === 'delete' ? `âš ï¸ è­¦å‘Šï¼šå³å°†åˆ é™¤èŠ‚ç‚¹ ${id}ï¼

æ­¤æ“ä½œå°†ï¼š
â€¢ åœæ­¢OpenClawæœåŠ¡
â€¢ å¤‡ä»½æ‰€æœ‰æ•°æ®
â€¢ æ¸…ç†è¿è¡Œæ—¶æ–‡ä»¶  
â€¢ ä»ç®¡ç†åˆ—è¡¨ä¸­ç§»é™¤

æ­¤æ“ä½œä¸å¯é€†ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ` :
          confirmDialog.action === 'restart-bot' ? `ç¡®å®šè¦é‡å¯ Bot ${confirmDialog.data?.botName} å—ï¼Ÿ` :
          'ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ'
        }
        confirmText={
          confirmDialog.action === 'delete' ? 'ç¡®è®¤åˆ é™¤' :
          confirmDialog.action === 'restart' || confirmDialog.action === 'restart-bot' ? 'ç¡®è®¤é‡å¯' :
          confirmDialog.action === 'test' ? 'å¼€å§‹æµ‹è¯•' :
          'ç¡®è®¤'
        }
        confirmColor={
          confirmDialog.action === 'delete' ? 'red' :
          confirmDialog.action === 'restart' || confirmDialog.action === 'restart-bot' ? 'red' : 'blue'
        }
        loading={actionLoading}
      />
    </div>
  );
}

export default NodeDetail;
