# /NM 命令行菜单系统 - OCM完整功能架构

## 📋 核心需求整理

### 1. 节点管理需求
- **添加节点**: IP输入 → SSH连接测试 → 系统检测 → OpenClaw自动安装 → 配置同步
- **删除节点**: 真正清理（停服务+删配置+清文件）而不是假删除
- **节点监控**: CPU/RAM/磁盘实时监控、在线状态、版本信息
- **节点操作**: 重启、备份、还原、健康检查、智力测试
- **状态显示**: 友好的错误信息（"未安装"而不是空白）

### 2. Bot/Agent管理需求  
- **Bot创建**: 🎭个性化设置 + 🔑订阅token配置 + workspace文件管理
- **Bot部署**: 一键启动、自动配置、Telegram bot绑定
- **Bot删除**: 真正删除所有相关文件和配置
- **Bot监控**: 运行状态、session数量、cron任务、内存健康分析
- **配置同步**: Agent配置跨节点同步、一致性检查

### 3. 系统监控需求
- **实时监控**: 系统资源、服务状态、网络连接
- **健康检查**: Agent通讯状态、消息总线、heartbeat配置
- **智力测试**: LLM性能评分、自动告警、历史趋势
- **错误追踪**: 日志分析、错误统计、问题诊断

### 4. 数据管理需求
- **备份系统**: 自动备份、手动备份、增量备份、版本管理
- **还原功能**: 选择性还原、一键回滚、安全检查
- **配置管理**: API密钥管理、环境配置、认证信息
- **版本控制**: Git集成、代码管理、自动部署

### 5. 用户体验需求
- **界面稳定性**: 修复空白页Bug、null值处理、错误边界
- **操作确认**: 危险操作二次确认、详细日志记录
- **实时反馈**: 操作进度显示、状态实时更新
- **移动适配**: 响应式设计、Touch友好

## 🖥️ /NM 命令行菜单系统设计

### 主命令架构
```
/NM     - 主菜单 (系统概览 + 功能导航)
/NM1-8  - 功能模块 (节点、Bot、监控等)
/NMS    - 快速状态 (一屏关键信息)
/NMH    - 健康检查 (全系统诊断)
/NME    - 紧急菜单 (重启、备份、恢复)
```

### /NM - 主界面
```
🚀 OCM (OpenClaw Cluster Manager) v1.0
📊 系统状态: 3节点在线 | 15个Agent运行 | 健康度98%
⚡ 最后更新: 2026-02-16 18:30:00

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【主菜单】
1️⃣ /NM1 - 节点管理 (Node Management)
2️⃣ /NM2 - Bot管理 (Bot Management)  
3️⃣ /NM3 - 系统监控 (System Monitor)
4️⃣ /NM4 - 备份还原 (Backup & Restore)
5️⃣ /NM5 - 配置管理 (Configuration)
6️⃣ /NM6 - 工具箱 (Toolbox)
7️⃣ /NM7 - 日志分析 (Log Analysis)
8️⃣ /NM8 - 系统设置 (Settings)

🔧 快捷命令: /NMS /NMH /NME
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### /NM1 - 节点管理
```
🖥️ 节点管理
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 当前: 3节点 | 在线: 2个 | 错误: 1个

🟢 PC-A (192.168.3.73)   - OpenClaw 2026.2.15 | 🧠98分
🟢 T440 (192.168.3.33)   - OpenClaw 2026.2.13 | 🧠95分  
🔴 PC-B (192.168.3.17)   - 未安装 | 安装失败

1️⃣ /NM11 - 添加节点 (自动安装向导)
2️⃣ /NM12 - 删除节点 (真正清理)
3️⃣ /NM13 - 节点详情 (详细状态)
4️⃣ /NM14 - 批量操作 (重启/备份/同步)
5️⃣ /NM15 - 智力测试 (性能评估)
6️⃣ /NM16 - 版本管理 (升级/降级)

⬅️ /NM - 返回主菜单
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### /NM2 - Bot管理
```
🤖 Bot/Agent管理  
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 总计: 15个 | 运行: 14个 | 停止: 1个

🟢 main (PC-A)          - 主助理 | 6会话 | 健康✅
🟢 techsfree-web (T440) - Web开发 | 3会话 | 健康✅
🔴 investment (T440)    - 投资助理 | 失联14h | 需修复
🟢 learning (T440)      - 学习助理 | 2会话 | 健康✅

1️⃣ /NM21 - 创建Bot (🎭个性+🔑token设置)
2️⃣ /NM22 - 删除Bot (真正删除)
3️⃣ /NM23 - Bot详情 (sessions/cron/memory)
4️⃣ /NM24 - 批量部署 (一键启动所有)
5️⃣ /NM25 - 配置同步 (跨节点同步)
6️⃣ /NM26 - 性能分析 (token使用/响应时间)

⬅️ /NM - 返回主菜单
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### /NM3 - 系统监控
```
📈 系统实时监控 (自动刷新30s)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔄 最后更新: 18:30:15

📊 资源使用:
  CPU: ████████░░ 78% (PC-A:45% T440:32%)  
  RAM: ██████░░░░ 64% (PC-A:2.1GB T440:1.8GB)
  磁盘: ███░░░░░░░ 28% (500GB总容量)

🌐 网络状态:
  ✅ 消息总线: 正常 | 193条消息 | 12ms延迟
  ✅ API服务: 正常 | 85ms响应
  ⚠️ Agent失联: techsfree-web (14小时)

1️⃣ /NM31 - 实时监控 (图表显示)
2️⃣ /NM32 - 错误日志 (问题追踪)
3️⃣ /NM33 - 性能分析 (瓶颈识别)
4️⃣ /NM34 - Agent通讯 (消息总线状态)

⬅️ /NM - 返回主菜单
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 快捷命令详细

#### /NMS - 快速状态
```
⚡ OCM 快速状态检查

🖥️ 节点: 2/3在线 | PC-B需修复
🤖 Agent: 14/15运行 | techsfree-web失联
📊 资源: CPU78% RAM64% 磁盘28%
🔄 服务: OCM✅ 消息总线✅ API✅
⚠️ 告警: 1个Agent失联14小时

输入 /NM 查看完整菜单
```

#### /NMH - 健康检查
```
🏥 系统健康检查报告

🔍 检查项目:
✅ 节点连通性 - 2/3正常
❌ Agent通讯 - 1个失联
✅ 消息总线 - 正常运行
✅ API服务 - 响应正常
✅ 数据库 - 连接正常
⚠️ 磁盘空间 - 使用率28%

🎯 建议操作:
1. 重启 techsfree-web Agent
2. 修复 PC-B 节点安装问题
3. 清理旧日志文件

总体健康度: 85% (良好)
```

#### /NME - 紧急操作菜单
```
🚨 紧急操作菜单

危险操作，请谨慎选择：
1️⃣ 全系统重启
2️⃣ 紧急备份
3️⃣ 从备份还原
4️⃣ 修复损坏节点
5️⃣ 强制清理僵尸进程
6️⃣ 重置所有配置

⚠️ 所有操作都需要二次确认
输入数字选择，或发送 /NM 返回主菜单
```

## 💡 实现技术细节

### 1. 命令处理流程
1. **消息检测**: 检查是否以 /NM 开头
2. **命令解析**: 解析具体功能模块
3. **权限验证**: 检查用户权限级别
4. **状态获取**: 实时获取系统状态
5. **界面渲染**: 生成格式化消息
6. **操作确认**: 危险操作二次确认

### 2. 数据源整合
- **Node Status**: curl API获取节点状态
- **Agent Status**: 消息总线API获取通讯状态  
- **System Resources**: SSH命令获取资源使用
- **Service Status**: systemctl检查服务状态
- **Database**: SQLite查询配置信息

### 3. 交互特性
- **智能按钮**: Telegram InlineKeyboard
- **实时更新**: 定时刷新关键数据
- **上下文保持**: 记住用户当前位置
- **错误恢复**: 操作失败自动返回菜单
- **历史记录**: 记录用户操作历史

### 4. 安全考虑
- **权限分级**: 只有owner能执行危险操作
- **操作确认**: 删除/重启等需要二次确认
- **日志记录**: 所有操作都记录到审计日志
- **时间窗口**: 危险操作有时间限制

## 🚀 实施步骤

### Phase 1: 基础框架 (1天)
1. 创建命令处理器框架
2. 实现主菜单和导航逻辑
3. 集成现有API获取系统状态
4. 基本的界面渲染功能

### Phase 2: 核心功能 (2天)
1. 节点管理功能完整实现
2. Bot管理功能完整实现
3. 系统监控实时数据
4. 操作确认和安全机制

### Phase 3: 高级功能 (1天)
1. 备份还原功能
2. 配置管理功能
3. 工具箱和诊断功能
4. 智能建议系统

### Phase 4: 优化完善 (0.5天)
1. 界面美化和用户体验
2. 性能优化和错误处理
3. 文档完善和测试
4. 部署和集成验证

这个命令行界面将成为OCM系统的强大控制中心，让你通过Telegram就能完全管理整个OpenClaw集群！