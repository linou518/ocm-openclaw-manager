# 🚀 OCM 一键自动安装 OpenClaw 功能

## ✨ 新增功能概览

OCM现在支持在添加节点时**一键自动安装OpenClaw**！无需手动SSH连接和配置。

### 🎯 功能特性

- ✅ **环境自动检测** - 支持Ubuntu/Debian/CentOS/Fedora/Arch
- ✅ **依赖自动安装** - 自动安装Node.js/npm等依赖
- ✅ **OpenClaw自动安装** - `npm install -g openclaw@latest`
- ✅ **服务自动配置** - 配置systemd服务或后台进程
- ✅ **健康检查** - 安装后自动验证服务状态
- ✅ **实时状态** - 安装进度实时更新到事件日志
- ✅ **错误处理** - 安装失败时提供详细错误信息

## 🖥️ 使用方法

### 1. **添加节点时启用自动安装**

1. 访问OCM界面: http://localhost:8001
2. 点击"节点管理" -> "添加节点"  
3. 填写节点信息：
   ```
   节点ID: test-01
   节点名称: 测试节点
   主机地址: 192.168.3.[18]  ← 只需输入最后一位
   SSH端口: 22
   SSH用户: openclaw[02]     ← 可选数字后缀  
   OpenClaw路径: /home/openclaw/.openclaw (默认)
   ```
4. **✅ 勾选"🚀 自动安装 OpenClaw"**
5. 点击"添加节点"

### 2. **监控安装进度**

- **节点状态变化**: `unknown` -> `installing` -> `online`
- **事件日志**: 实时显示安装进度和结果
- **健康检查**: 安装完成后自动执行

## 🔧 技术实现

### 后端API增强

#### 新增/修改的端点：
- `POST /api/nodes` - 支持 `auto_install` 参数
- `GET /api/nodes/:id/install-status` - 查询安装状态

#### 安装流程：
```
1. 添加节点到数据库 (状态: installing)
2. 触发后台Python安装脚本
3. 环境检测和依赖安装
4. OpenClaw安装和配置  
5. 服务启动和验证
6. 健康检查和状态更新
```

### 前端界面改进

- ✅ **简化IP输入**: `192.168.3.` + `[数字]`
- ✅ **简化用户输入**: `openclaw` + `[可选后缀]`
- ✅ **自动安装选项**: 复选框 + 状态说明
- ✅ **安装状态提示**: 成功消息包含安装状态

## 📊 安装脚本详情

### 支持的环境
- **Ubuntu/Debian**: apt包管理器
- **CentOS/RHEL**: yum/dnf包管理器  
- **Fedora**: dnf包管理器
- **Arch Linux**: pacman包管理器
- **通用Linux**: 使用wget/curl下载

### 安装步骤
1. **系统检测**: 识别操作系统和版本
2. **预检查**: 检查现有Node.js/npm安装
3. **依赖安装**: 根据系统安装Node.js LTS
4. **OpenClaw安装**: `npm install -g openclaw@latest`
5. **服务配置**: systemd用户服务或后台进程
6. **验证测试**: 检查服务启动状态
7. **健康检查**: CPU/内存/进程监控
8. **状态上报**: 更新数据库和事件日志

## 🛠️ 故障排除

### 常见问题

#### 1. **SSH连接失败**
```
错误: 无法连接到主机
解决: 
- 检查IP地址是否正确
- 确认SSH服务运行在指定端口
- 验证用户名和认证方式
```

#### 2. **权限不足**
```
错误: 没有sudo权限
解决:
- 确保SSH用户有sudo权限
- 或预先手动安装Node.js
```

#### 3. **网络问题**
```
错误: 无法下载Node.js/OpenClaw
解决:
- 检查节点网络连接
- 配置代理或使用内网镜像
```

#### 4. **服务启动失败**
```
错误: OpenClaw服务无法启动
解决:
- 检查端口占用
- 查看服务日志
- 手动运行 openclaw gateway
```

### 手动修复

如果自动安装失败，可以使用**修复功能**:
1. 在节点列表中找到失败的节点
2. 点击"修复"按钮
3. 系统会重新尝试安装OpenClaw

## 📈 监控和维护

### 状态监控
- **实时状态**: Dashboard显示所有节点状态
- **健康检查**: 每5分钟自动检查节点状态  
- **告警通知**: 节点离线时记录事件
- **性能监控**: CPU/内存/磁盘使用率

### 日志查看
- **事件日志**: 查看安装和运行历史
- **系统日志**: SSH到节点查看详细日志
- **服务状态**: `systemctl --user status openclaw-gateway`

## 🔄 升级和回滚

### OpenClaw版本管理
- **版本检测**: 自动识别已安装版本
- **升级支持**: 后续支持一键升级
- **备份恢复**: 集成Git备份系统

## 🚨 安全考虑

### SSH认证
- 优先使用SSH密钥认证
- 支持密码认证（测试环境）
- 连接超时和重试机制

### 权限管理
- 最小权限原则
- sudo权限仅用于包安装
- 用户级服务运行

## 📞 支持

如果遇到问题：
1. 查看事件日志获取详细错误信息
2. 检查服务器日志: `tail -f /path/to/ocm/server.log`
3. 手动SSH测试连接和权限
4. 联系技术支持

---

**🎉 享受一键安装的便利！**